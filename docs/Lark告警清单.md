# Lark告警清单

> 更新日期：2026年1月15日

本文档列出系统中所有发送Lark告警或通知的位置、触发条件和告警内容。

---

## 一、告警类型汇总

| 告警类型 | 代码常量 | 严重程度 | 说明 |
|---------|---------|---------|------|
| 价格无效 | `AlertTypePriceInvalid` | 🔴 严重 | 价格数据校验失败 |
| 时间戳过期 | `AlertTypeTimestampExpired` | ⚠️ 警告 | 价格时间戳超过5分钟 |
| 切换差异过大 | `AlertTypeSwitchDiff` | ⚠️ 警告 | 数据源切换时价格差异 > 5% |
| 两个预言机都异常 | `AlertTypeBothOracleError` | 🔴 严重 | Pyth和Gate都异常，暂停报价 |
| 数据源错误 | `AlertTypeDataSourceError` | 🔴 严重 | 链上推送失败 |
| 重连失败 | `AlertTypeReconnectFailed` | 🔴 致命 | 数据源重连失败达到上限，程序终止 |
| 状态查询失败 | `AlertTypeStatusQueryFailed` | 🔴 致命 | 状态查询失败达到上限，程序终止 |
| 股票状态异常 | `AlertTypeStockStatusError` | 🔴 严重 | 股票状态异常，暂停报价 |

---

## 二、详细告警清单

### 1. 价格无效告警 (AlertTypePriceInvalid)

**触发位置**：3处

#### 1.1 CEX数据源价格无效

**文件**：`internal/oracle/service.go`  
**位置**：`handleCEXQuote()` 方法，第441行  
**触发条件**：
- 当前使用CEX数据源
- 价格校验失败（价格 ≤ 0）

**告警内容**：
```json
{
  "告警类型": "❌ 价格无效",
  "股票代币": "AAPLX",
  "价格": "0",
  "原因": "价格必须大于0"
}
```

#### 1.2 Pyth数据源价格无效

**文件**：`internal/oracle/service.go`  
**位置**：`handlePythPrice()` 方法，第488行  
**触发条件**：
- Pyth价格校验失败（价格 ≤ 0）

**告警内容**：
```json
{
  "告警类型": "❌ 价格无效",
  "股票代币": "AAPLX",
  "数据源": "Pyth",
  "价格": "0",
  "原因": "价格必须大于0"
}
```

#### 1.3 Gate数据源价格无效

**文件**：`internal/oracle/service.go`  
**位置**：`handleGatePrice()` 方法，第574行  
**触发条件**：
- Gate价格校验失败（价格 ≤ 0）

**告警内容**：
```json
{
  "告警类型": "❌ 价格无效",
  "股票代币": "AAPLX",
  "数据源": "Gate",
  "价格": "0",
  "原因": "价格必须大于0"
}
```

---

### 2. 时间戳过期告警 (AlertTypeTimestampExpired)

**触发位置**：3处

#### 2.1 CEX数据源时间戳过期

**文件**：`internal/oracle/service.go`  
**位置**：`handleCEXQuote()` 方法，第452行  
**触发条件**：
- 当前使用CEX数据源
- 价格时间戳与系统时间相差 ≥ 5分钟

**告警内容**：
```json
{
  "告警类型": "⚠️ 时间戳过期",
  "股票代币": "AAPLX",
  "时间戳": "2026-01-15 10:00:00",
  "原因": "价格时间戳与系统时间相差超过5分钟"
}
```

#### 2.2 Pyth数据源时间戳过期

**文件**：`internal/oracle/service.go`  
**位置**：`handlePythPrice()` 方法，第499行  
**触发条件**：
- Pyth价格时间戳与系统时间相差 ≥ 5分钟

**告警内容**：
```json
{
  "告警类型": "⚠️ 时间戳过期",
  "股票代币": "AAPLX",
  "数据源": "Pyth",
  "时间戳": "2026-01-15 10:00:00",
  "原因": "价格时间戳与系统时间相差超过5分钟"
}
```

#### 2.3 Gate数据源时间戳过期

**文件**：`internal/oracle/service.go`  
**位置**：`handleGatePrice()` 方法，第585行  
**触发条件**：
- Gate价格时间戳与系统时间相差 ≥ 5分钟

**告警内容**：
```json
{
  "告警类型": "⚠️ 时间戳过期",
  "股票代币": "AAPLX",
  "数据源": "Gate",
  "时间戳": "2026-01-15 10:00:00",
  "原因": "价格时间戳与系统时间相差超过5分钟"
}
```

---

### 3. 切换差异过大告警 (AlertTypeSwitchDiff)

**触发位置**：1处

#### 3.1 数据源切换价格差异过大

**文件**：`internal/oracle/service.go`  
**位置**：`onDataSourceChange()` 方法，第700行  
**触发条件**：
- 数据源切换时（CEX ↔ 加权合成）
- 切换前后价格差异 ≥ 5%

**告警内容**：
```json
{
  "告警类型": "⚠️ 切换差异过大",
  "股票代币": "AAPLX",
  "触发场景": "数据源切换 CEX -> WEIGHTED",
  "上次价格": "100.00",
  "当前价格": "106.00",
  "差异": "6.00%",
  "原因": "数据源切换价格差异超过5%阈值"
}
```

**后续操作**：
1. 回滚数据源到原来的状态
2. 暂停该股票报价
3. 下次轮询时会再次尝试切换

---

### 4. 两个预言机都异常告警 (AlertTypeBothOracleError)

**触发位置**：1处

#### 4.1 两个预言机都异常

**文件**：`internal/oracle/service.go`  
**位置**：`calculateAndPushWeightedPrice()` 方法，第815行  
**触发条件**：
- 当前使用加权合成数据源
- Pyth和Gate两个预言机都异常
- 首次触发（有去重机制，每个股票只告警一次）

**告警内容**：
```json
{
  "告警类型": "🔴 两个预言机都异常",
  "股票代币": "AAPLX",
  "Pyth状态": "abnormal",
  "Gate状态": "abnormal",
  "说明": "两个预言机都异常，已暂停报价"
}
```

**后续操作**：
1. 暂停该股票报价
2. 任一预言机恢复后，自动恢复报价

**去重机制**：
- 使用 `bothOracleAlerted` map 记录每个股票是否已告警
- 恢复后会重置告警状态，下次异常时会再次告警

---

### 5. 数据源错误告警 (AlertTypeDataSourceError)

**触发位置**：1处

#### 5.1 批量链上推送失败

**文件**：`internal/oracle/service.go`  
**位置**：`onBatchFlush()` 方法，第198行  
**触发条件**：
- 批量推送价格到链上失败
- 已重试3次（指数退避：100ms, 200ms, 400ms）
- 所有重试都失败

**告警内容**：
```json
{
  "告警类型": "❌ 数据源错误",
  "操作": "批量链上推送",
  "股票数量": "3",
  "股票列表": "[AAPLX NVDAX TSLAX]",
  "错误": "连接超时",
  "重试次数": "3"
}
```

---

### 6. 重连失败告警 (AlertTypeReconnectFailed)

**触发位置**：1处

#### 6.1 数据源重连失败（致命错误）

**文件**：`internal/oracle/service.go`  
**位置**：`handleFatalError()` 方法，第212行  
**触发条件**：
- 数据源重连失败达到上限（10次）
- 程序即将终止

**告警内容**：
```json
{
  "告警类型": "🔴 数据源重连失败",
  "错误来源": "CEX",
  "错误详情": "连接失败: connection timeout",
  "说明": "致命错误，程序即将终止"
}
```

**后续操作**：
1. 等待2秒确保告警发送完成
2. 程序终止（`log.Fatal()`）

**触发来源**：
- CEX WebSocket客户端重连失败
- Pyth SSE客户端重连失败
- Gate WebSocket客户端重连失败

---

### 7. 状态查询失败告警 (AlertTypeStatusQueryFailed)

**触发位置**：1处

#### 7.1 状态查询失败（致命错误）

**文件**：`internal/state/manager.go`  
**位置**：`recordQueryFailure()` 方法，第192行  
**触发条件**：
- 市场状态或股票状态查询连续失败10次
- 程序即将终止

**告警内容**：
```json
{
  "告警类型": "🔴 状态查询失败",
  "查询类型": "市场状态",
  "失败次数": "10",
  "最后错误": "请求失败: connection timeout",
  "说明": "连续查询失败次数达到上限，程序即将终止"
}
```

**后续操作**：
1. 触发致命错误回调
2. 程序终止

---

### 8. 股票状态异常告警 (AlertTypeStockStatusError)

**触发位置**：1处

#### 8.1 股票状态异常，暂停报价

**文件**：`internal/state/manager.go`  
**位置**：`updateStatus()` 方法，第229行  
**触发条件**：
- 股票状态异常（halted、suspended等非normal状态）
- 且市场状态不在交易时段
- 或股票状态异常且市场状态在交易时段（特殊情况）
- 首次触发（有去重机制）

**告警内容**：
```json
{
  "告警类型": "🔴 股票状态异常",
  "股票代币": "AAPLX",
  "市场状态": "trading",
  "股票状态": "halted",
  "原因": "股票状态异常，暂停报价"
}
```

**后续操作**：
1. 暂停该股票报价
2. 股票状态恢复后，自动恢复报价

---

## 三、告警去重机制

### 已实现去重的告警

1. **两个预言机都异常告警**
   - 使用 `bothOracleAlerted` map 记录
   - 每个股票只告警一次
   - 恢复后重置状态，下次异常会再次告警

2. **股票状态异常告警**
   - 使用 `pausedStocks` map 记录
   - 每个股票只告警一次
   - 恢复后自动清除记录

### 未实现去重的告警

以下告警每次触发都会发送，**可能会有重复告警**：

1. **价格无效告警**（CEX/Pyth/Gate）
2. **时间戳过期告警**（CEX/Pyth/Gate）
3. **切换差异过大告警**
4. **数据源错误告警**（批量推送失败）
5. **重连失败告警**（致命错误，程序终止）
6. **状态查询失败告警**（致命错误，程序终止）

---

## 四、告警触发频率统计

### 高频告警（可能频繁触发）

1. **价格无效告警**：每次收到无效价格时触发
2. **时间戳过期告警**：每次收到过期价格时触发
3. **切换差异过大告警**：每次切换且差异 > 5% 时触发

### 中频告警（偶尔触发）

1. **两个预言机都异常告警**：每个股票异常时触发一次（有去重）
2. **数据源错误告警**：批量推送失败且重试3次后触发

### 低频告警（罕见）

1. **股票状态异常告警**：股票状态异常时触发（有去重）
2. **重连失败告警**：致命错误，程序终止前触发
3. **状态查询失败告警**：致命错误，程序终止前触发

---

## 五、告警严重程度分级

### 🔴 致命错误（程序终止）

1. **重连失败告警** (`AlertTypeReconnectFailed`)
2. **状态查询失败告警** (`AlertTypeStatusQueryFailed`)

### 🔴 严重错误（暂停报价）

1. **价格无效告警** (`AlertTypePriceInvalid`)
2. **两个预言机都异常告警** (`AlertTypeBothOracleError`)
3. **股票状态异常告警** (`AlertTypeStockStatusError`)
4. **数据源错误告警** (`AlertTypeDataSourceError`)

### ⚠️ 警告（不影响运行，需要关注）

1. **时间戳过期告警** (`AlertTypeTimestampExpired`)
2. **切换差异过大告警** (`AlertTypeSwitchDiff`)

---

## 六、告警统计汇总

| 告警类型 | 触发位置数 | 去重机制 | 严重程度 | 频率 |
|---------|-----------|---------|---------|------|
| 价格无效 | 3 | ❌ | 🔴 严重 | 高频 |
| 时间戳过期 | 3 | ❌ | ⚠️ 警告 | 高频 |
| 切换差异过大 | 1 | ❌ | ⚠️ 警告 | 中频 |
| 两个预言机都异常 | 1 | ✅ | 🔴 严重 | 中频 |
| 数据源错误 | 1 | ❌ | 🔴 严重 | 中频 |
| 重连失败 | 1 | ❌ | 🔴 致命 | 低频 |
| 状态查询失败 | 1 | ❌ | 🔴 致命 | 低频 |
| 股票状态异常 | 1 | ✅ | 🔴 严重 | 低频 |
| **总计** | **12** | **2** | - | - |

---

## 七、告警发送方式

### 异步发送

所有告警都通过 `alertManager.SendAlert()` 异步发送，不会阻塞主流程：

```go
// 异步发送，不阻塞主流程
go func() {
    if err := l.sendCardAlert(alertType, symbol, details); err != nil {
        // 降级为文本告警
        l.sendTextAlert(alertType, symbol, details)
    }
}()
```

### 降级机制

- 优先发送卡片告警（富文本格式）
- 失败时自动降级为文本告警
- 确保告警能够送达

---

## 八、告警内容格式

### 卡片告警格式

```json
{
  "msg_type": "interactive",
  "card": {
    "config": {
      "wide_screen_mode": true
    },
    "header": {
      "title": {
        "tag": "plain_text",
        "content": "⚠️ 切换差异过大"
      },
      "template": "orange"
    },
    "elements": [
      {
        "tag": "div",
        "fields": [
          {
            "is_short": true,
            "text": {
              "tag": "lark_md",
              "content": "**股票代币**\nAAPLX"
            }
          },
          {
            "is_short": true,
            "text": {
              "tag": "lark_md",
              "content": "**告警时间**\n2026-01-15 10:00:00"
            }
          },
          {
            "is_short": false,
            "text": {
              "tag": "lark_md",
              "content": "**触发场景**\n数据源切换 CEX -> WEIGHTED"
            }
          }
        ]
      }
    ]
  }
}
```

### 文本告警格式（降级）

```
【⚠️ 切换差异过大】股票代币: AAPLX
时间: 2026-01-15 10:00:00
触发场景: 数据源切换 CEX -> WEIGHTED
上次价格: 100.00
当前价格: 106.00
差异: 6.00%
原因: 数据源切换价格差异超过5%阈值
```

---

## 九、建议优化

### 1. 告警去重优化

以下告警建议增加去重机制，避免重复告警：

1. **价格无效告警**：可以按股票代币去重，每分钟最多告警一次
2. **时间戳过期告警**：可以按股票代币去重，每分钟最多告警一次
3. **切换差异过大告警**：可以按股票代币去重，每次切换只告警一次

### 2. 告警聚合

对于高频告警，可以聚合后批量发送：

- 将相同类型的告警聚合在一起
- 每隔一段时间（如1分钟）批量发送
- 减少告警数量，提高可读性

### 3. 告警级别调整

根据告警的实际影响，可以调整告警级别：

- **时间戳过期**：如果频繁触发且不影响核心功能，可以降低为信息级别
- **价格无效**：如果偶尔触发且是数据源问题，可以保持警告级别

---

## 十、总结

系统共有**12处**发送Lark告警的位置，涵盖以下场景：

1. **数据校验**：价格无效、时间戳过期（6处）
2. **数据源切换**：切换差异过大（1处）
3. **预言机异常**：两个预言机都异常（1处）
4. **系统错误**：批量推送失败（1处）
5. **致命错误**：重连失败、状态查询失败（2处）
6. **状态异常**：股票状态异常（1处）

其中**2种告警**已实现去重机制，其他告警可能会重复发送。建议根据实际运行情况，对高频告警增加去重或聚合机制。
