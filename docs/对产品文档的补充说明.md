> 这篇文档是对产品文档的补充，产品文档有些地方说的比较复杂，在和 cex 那边的同事（负责纳斯达克和 BlueOcean 的实时报价推送）聊过之后，有些规则需要说明一下。

## 核心架构

```plaintext
┌─────────────────────────────────────────────────────────────┐
│                      报价系统                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────────┐         ┌─────────────────────────────┐  │
│   │  CEX 数据源  │         │      加权合成数据源          │  │
│   │             │         │                             │  │
│   │ • 盘前价格   │         │ • CEX收盘价 (40%)           │  │
│   │ • 盘中价格   │   OR    │ • Pyth Network (30%)       │  │
│   │ • 盘后价格   │         │ • Gate.io (30%)            │  │
│   │ • 夜盘价格   │         │                             │  │
│   └─────────────┘         └─────────────────────────────┘  │
│         ↑                           ↑                       │
│         │                           │                       │
│   市场状态+股票状态                非活跃状态                 │
│   (盘前/盘中/盘后/夜盘              (周末/节假日/熔断/         │
│    且 股票=normal)                  提前休市等)               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 关键修正点（补充说明 vs 原产品文档）

| 项目               | 原产品文档                                     | 补充说明                                  |
| ------------------ | ---------------------------------------------- | ----------------------------------------- |
| 加权报价数据源     | 收盘价 + Pyth + **Chainlink**                  | 收盘价 + Pyth + [Gate.io](http://Gate.io) |
| 时间判断方式       | 按具体时间点切换（04:00、09:30、16:00、20:00） | 按 CEX 市场状态接口判断                   |
| 半日交易/熔断识别  | 需要手动识别特定日期                           | 通过 CEX 接口判断市场状态和股票状态       |
| 价格校验范围       | > 0 且 < 100,000                               | 只需要 > 0                                |
| CEX 价格跳变 > 10% | 需要处理                                       | 不用管，继续使用 CEX 报价                 |
| 状态轮询频率       | 未明确                                         | 每 3 秒查询一次                           |
| 告警方式           | 未明确                                         | Lark 群通知                               |
| 存储需求           | 未明确                                         | CEX 收盘价快照 + Pyth/Gate 最新有效报价   |

## 数据源切换逻辑

### CEX 市场状态表

| 状态              | 含义     | 使用数据源 |
| ----------------- | -------- | ---------- |
| pre_hour_trading  | 盘前     | CEX        |
| trading           | 盘中     | CEX        |
| post_hour_trading | 盘后     | CEX        |
| overnight         | 夜盘     | CEX        |
| not_yet_open      | 未开盘   | 加权合成   |
| middle_close      | 午间休市 | 加权合成   |
| closing           | 收盘     | 加权合成   |
| early_closed      | 提前休市 | 加权合成   |
| market_closed     | 休市     | 加权合成   |

### 股票状态表

| 状态            | 含义 | 使用数据源/处理                                                             |
| --------------- | ---- | --------------------------------------------------------------------------- |
| normal          | 正常 | 结合市场状态：<br/>市场 ∈ {盘前/盘中/盘后/夜盘} → CEX 报价；否则 → 加权合成 |
| circuit_breaker | 熔断 | 加权合成（即便市场在交易时段，也不直接用 CEX 报价）                         |
| 其他状态        | -    | 暂停报价 + Lark 告警                                                        |

### 切换判断公式

```plaintext
使用 CEX 报价的条件：
  市场状态 ∈ {盘前, 盘中, 盘后, 夜盘} AND 股票状态 = normal

否则：
  - 股票状态 = circuit_breaker：加权合成报价
  - 股票状态 为其他：暂停报价 + Lark 告警
```

## 加权合成报价计算

### 数据切换流程及收盘价获取方式

收盘价不再是按天固化，而是在切换到加权合成报价时，从“最后一条 CEX WS 推送”取值；系统需持续覆盖缓存最新 WS 数据。WS 推送示例：

```json
{
        "symbol": "00700",         //交易对
        "amount": 3384300419,      //成交额
        "bid_high_price": 9.0,     //竞价最高价
        "blue_price": "9.0",       //夜盘最新价 夜盘时段价格
        "blue_up_down_amount": "91.0",  //夜盘价格涨跌额
        "blue_up_down_percent": "9.0",  //夜盘价格涨跌幅百分比
        "bid_up_down_amount": 0.0, //竞价涨跌额
        "bid_low_price": 0.0,      //竞价最低价
        "bid_volume": 0,           //竞价成交量
        "latest_price": 372.6,     //最新价 ： 盘中价格
        "type": "stock",           //订阅类型  stock股票 option期权
        "up_down_percent": 0.0,    //竞价涨跌幅
        "market": "HK",            //市场 US / HK
        "volume": 8978887,         //成交量
        "bid_timestamp": 0,        //竞价时间
        "high": 380.0,             //最高价
        "bid_amount": 0.0,         //竞价成交额
        "up_down_amount": 0.0,     //涨跌额
        "low": 372.2,              //最低价
        "data_type": "Q",          //数据类型
        "symbol_type": 1,          //证券类型
        "close": 382.0,            //收盘价
        "bid_price": 0.0,          //竞价价格 ： 盘前，盘后价
        "open": 379.6,             //开盘价
        "marketStatus":"Regular"   //市场状态 盘中Regular 盘前PreMarket 盘后AfterHours，夜盘OverNight
        "timestamp": 1719466061924 //行情数据时间戳
}
```

需要重点关注以下几个字段

- bid_price：盘前价、盘后价都从它获取
- latest_price：盘中价从它获取
- bule_price：夜盘价从它获取
- marketStatus：市场状态（盘前：PreMarket、盘中：Regular、盘后：AfterHours、夜盘：OverNight）

流程：

1. 每 3 秒查询市场状态和股票状态：
   - 市场 ∈ {盘前/盘中/盘后/夜盘} 且 股票 = normal → 用 CEX 报价（WS 在这些状态下有推送）。
   - 股票 = circuit_breaker → 直接用加权合成（即便市场在交易时段）。
   - 股票为其他状态 → 暂停报价 + Lark 告警。
2. 需要切换到加权合成时（市场不在交易时段，或股票=熔断等）：
   - 读取缓存的“最后一条 CEX WS 推送”里的 marketStatus，确定收盘价来源：
     - PreMarket / AfterHours → `bid_price`
     - Regular → `latest_price`
     - OverNight → `bule_price`
   - 将收盘价写入 Redis，用于加权合成。
3. 市场状态恢复且股票=normal 时，再从 CEX WS 报价恢复使用。

### 正常权重

```plaintext
加权价格 = CEX收盘价 × 0.4 + Pyth价格 × 0.3 + Gate价格 × 0.3
```

### 降级权重（预言机异常时）

| 异常情况         | 计算公式                  |
| ---------------- | ------------------------- |
| Pyth 异常        | 收盘价 × 0.6 + Gate × 0.4 |
| Gate 异常        | 收盘价 × 0.6 + Pyth × 0.4 |
| 收盘价异常       | Pyth × 0.5 + Gate × 0.5   |
| 两个预言机都异常 | 暂停报价 + Lark 告警      |

## 价格跳变处理

| 数据源 | 跳变>10%处理                                   |
| ------ | ---------------------------------------------- |
| CEX    | 不处理，继续使用（只要市场状态和股票状态正常） |
| Pyth   | 降权，持续监听，恢复正常后恢复权重             |
| Gate   | 降权，持续监听，恢复正常后恢复权重             |

## 价格校验规则

| 校验项   | 规则                    | 处理方式                     |
| -------- | ----------------------- | ---------------------------- |
| 价格范围 | >0                      | 不满足则暂停报价 + Lark 告警 |
| 时间戳   | 与系统时间相差 < 5 分钟 | 超时则暂停报价 + Lark 告警   |
| 切换差异 | ≥ 5%                    | 暂停报价 + Lark 告警         |

## 价格格式化

```go
func formatPrice(price float64) float64 {
    if price < 1 {
        return math.Floor(price * 10000) / 10000  // 4位小数，舍位
    }
    return math.Floor(price * 100) / 100  // 2位小数，舍位
}
```

## 推送时机

1. 仅在价格变化时推送（前后价格不一样）
2. 数据源切换后立即推送一次
3. 无变化时不推送（但要定期对 cex、pyth 以及 gate 进行连接检测，定时心跳保活）

## 存储需求

| 存储项            | 说明                                                          |
| ----------------- | ------------------------------------------------------------- |
| CEX 收盘价快照    | 在从 CEX 切换到加权合成报价时，根据最后一条 WS 推送计算并缓存 |
| Pyth 最新有效报价 | 用于跳变判断和降级恢复                                        |
| Gate 最新有效报价 | 用于跳变判断和降级恢复                                        |

## 系统定时任务

| 任务              | 频率                  |
| ----------------- | --------------------- |
| 查询 CEX 市场状态 | 3 秒                  |
| 查询股票状态      | 3 秒                  |
| 监听 Pyth 价格    | 实时（SSE）           |
| 监听 Gate 价格    | 实时（WebSocket）     |
| 监听 CEX 价格     | 实时（由 CEX 方提供） |

接下来需要做的工作是：

1. CEX 数据源对接（市场状态接口、股票状态接口、实时报价）
2. 状态管理模块（3 秒轮询市场/股票状态，决定使用哪个数据源）
3. 加权合成报价模块（整合 CEX 收盘价 + Pyth + Gate）
4. 价格校验模块（>0、时间戳<5 分钟、切换差异<5%）
5. 降级处理模块（Pyth/Gate 跳变>10%时的权重调整）
6. 告警模块（Lark 群通知）
7. 存储模块（收盘价、Pyth/Gate 最新有效报价）
8. 链上推送模块
