# 市场状态模拟服务使用指南

## 概述

市场状态模拟服务是一个用于测试的本地HTTP服务，可以随时控制市场状态，从而触发数据源切换（CEX ↔ 加权合成），方便测试5%差异检测和告警机制。

## 为什么需要这个服务？

在实际测试中，市场休市只发生在周末或节假日，不方便随时测试数据源切换逻辑。通过这个模拟服务，可以：

1. **随时触发数据源切换**：通过修改市场状态，立即触发从CEX切换到加权合成（或反之）
2. **测试5%差异检测**：验证当两种数据源价格差异 > 5% 时，是否正确触发告警和暂停报价
3. **测试异常恢复**：验证当价格差异恢复正常时，程序是否自动恢复报价

## 快速开始

### 1. 启动模拟服务

```bash
# 方式1：直接运行
cd cmd/mock-market-status
go run main.go

# 方式2：编译后运行
go build -o ../../bin/mock-market-status main.go
../../bin/mock-market-status

# 方式3：指定端口和状态文件
go run main.go -port 8888 -state-file ./market_status.json
```

服务启动后会显示：
```
[模拟服务] 🚀 市场状态模拟服务已启动
[模拟服务] 📍 监听地址: http://localhost:8888
[模拟服务] 📖 帮助页面: http://localhost:8888/
[模拟服务] 🔍 查看状态: http://localhost:8888/status
[模拟服务] ⚙️  设置状态: http://localhost:8888/status/set
[模拟服务] 📡 程序接口: http://localhost:8888/market/get
[模拟服务] 📊 当前市场状态: TRADING
```

### 2. 修改配置文件

在 `config.yaml` 中，将 `cex.market_status_url` 指向本地模拟服务：

```yaml
cex:
  market_status_url: "http://localhost:8888/market/get"  # 使用本地模拟服务
  stock_status_url: "https://japi-stock-quote.biya.in/quote/briefs"
  ws_base_url: "wss://market-ws.biya.in/market/subscribe"
```

### 3. 启动报价程序

正常启动报价程序，程序会从本地模拟服务获取市场状态：

```bash
./bin/oracle
```

### 4. 控制市场状态

#### 方式1：使用curl命令（推荐）

```bash
# 设置为休市（触发切换到加权合成）
curl -X POST http://localhost:8888/status/set \
  -H "Content-Type: application/json" \
  -d '{"trading_status": "MARKET_CLOSED"}'

# 设置为交易中（触发切换到CEX）
curl -X POST http://localhost:8888/status/set \
  -H "Content-Type: application/json" \
  -d '{"trading_status": "TRADING"}'

# 查看当前状态
curl http://localhost:8888/status
```

#### 方式2：使用示例脚本

```bash
cd cmd/mock-market-status
./example.sh
```

#### 方式3：使用Web界面

访问 `http://localhost:8888/` 查看帮助页面和API文档。

## API接口说明

### GET /market/get

返回市场状态（与真实API格式一致，程序使用此接口）

**响应格式：**
```json
{
  "code": 200,
  "msg": "success",
  "data": [
    {
      "market": "US",
      "status_cn": "市场休市",
      "open_time": "09:30",
      "trading_status": "MARKET_CLOSED",
      "status": "Closed"
    }
  ],
  "result": true
}
```

### GET /status

查看当前市场状态（用于调试）

**响应格式：**
```json
{
  "code": 200,
  "msg": "success",
  "result": true,
  "current": {
    "market": "US",
    "status_cn": "市场休市",
    "open_time": "09:30",
    "trading_status": "MARKET_CLOSED",
    "status": "Closed"
  }
}
```

### POST /status/set

设置市场状态（用于触发数据源切换）

**请求格式：**
```json
{
  "trading_status": "MARKET_CLOSED",  // 必需：交易状态
  "status_cn": "市场休市",              // 可选：中文状态（不提供则自动生成）
  "status": "Closed"                   // 可选：状态（不提供则自动生成）
}
```

**响应格式：**
```json
{
  "code": 200,
  "msg": "success",
  "result": true,
  "old": "TRADING",
  "new": "MARKET_CLOSED",
  "message": "市场状态已从 TRADING 更新为 MARKET_CLOSED"
}
```

## 常用状态值

| 状态值 | 说明 | 数据源选择 | 使用场景 |
|--------|------|-----------|---------|
| `TRADING` | 交易中 | CEX | 正常交易时段 |
| `MARKET_CLOSED` | 市场休市 | 加权合成 | 测试切换到加权合成 |
| `OVERNIGHT` | 夜盘交易 | CEX | 夜盘时段 |
| `PRE_HOUR_TRADING` | 盘前交易 | 加权合成 | 盘前时段 |
| `POST_HOUR_TRADING` | 盘后交易 | 加权合成 | 盘后时段 |
| `CLOSING` | 收盘中 | 加权合成 | 收盘时段 |
| `NOT_YET_OPEN` | 尚未开盘 | 加权合成 | 开盘前 |

## 测试场景

### 场景1：测试数据源切换

**目标**：验证程序能正确响应市场状态变化，切换数据源。

**步骤**：
1. 启动模拟服务
2. 启动报价程序（配置指向本地模拟服务）
3. 等待程序稳定运行，确认使用CEX数据源（查看日志中的 `[服务] 数据源: CEX`）
4. 设置市场状态为 `MARKET_CLOSED`：
   ```bash
   curl -X POST http://localhost:8888/status/set \
     -H "Content-Type: application/json" \
     -d '{"trading_status": "MARKET_CLOSED"}'
   ```
5. 等待3秒（程序每3秒轮询一次市场状态）
6. 观察日志，应该看到：
   - `[服务] 市场状态变化: TRADING -> MARKET_CLOSED`
   - `[服务] 数据源切换: CEX -> WEIGHTED`
   - `[服务] 开始使用加权合成价格`

### 场景2：测试5%差异告警

**目标**：验证当两种数据源价格差异 > 5% 时，是否正确触发告警和暂停报价。

**步骤**：
1. 确保程序使用CEX数据源，记录当前价格（例如：AAPLX = 100）
2. 设置市场状态为 `MARKET_CLOSED`（切换到加权合成）
3. 如果加权合成价格与CEX价格差异 > 5%（例如：加权合成 = 106，差异 = 6%），应该：
   - 触发告警：`[服务] ⚠️ 数据源切换价格差异过大: 6.00%`
   - 暂停报价：`[服务] 暂停报价: 数据源切换价格差异过大`
   - 回滚数据源：`[服务] 数据源回滚: WEIGHTED -> CEX`
4. 如果差异持续 > 5%，程序应该保持暂停状态

### 场景3：测试价格恢复

**目标**：验证当价格差异恢复正常时，程序是否自动恢复报价。

**步骤**：
1. 在场景2的基础上，等待加权合成价格恢复（或手动调整）
2. 当价格差异 < 5% 时（例如：CEX = 100，加权合成 = 103，差异 = 3%），程序应该：
   - 自动恢复报价：`[服务] 恢复报价: 价格差异已恢复正常`
   - 继续使用加权合成数据源

### 场景4：测试多次切换

**目标**：验证程序能正确处理多次数据源切换。

**步骤**：
1. 从CEX切换到加权合成（设置 `MARKET_CLOSED`）
2. 等待程序稳定运行
3. 从加权合成切换回CEX（设置 `TRADING`）
4. 观察日志，确认每次切换都正确执行

## 状态持久化

如果指定了 `-state-file` 参数，状态会保存到文件中：

```bash
go run main.go -state-file ./market_status.json
```

**特性**：
- 启动时自动加载文件中的状态
- 每次修改状态时自动保存到文件
- 重启服务后状态保持不变

**状态文件格式**：
```json
{
  "market": "US",
  "status_cn": "市场休市",
  "open_time": "09:30",
  "trading_status": "MARKET_CLOSED",
  "status": "Closed"
}
```

## 注意事项

1. **仅用于测试**：此服务仅用于测试环境，不要在生产环境使用
2. **端口冲突**：确保端口8888未被占用，或使用 `-port` 参数指定其他端口
3. **配置文件**：修改 `config.yaml` 后需要重启报价程序
4. **数据源切换**：切换市场状态后，程序会在下一次轮询（3秒）时检测并切换数据源
5. **状态同步**：程序每3秒轮询一次市场状态，状态变化会有最多3秒的延迟

## 故障排查

### 问题1：程序无法连接到模拟服务

**症状**：程序日志显示 `请求失败` 或 `连接被拒绝`

**解决方案**：
1. 检查模拟服务是否已启动：
   ```bash
   curl http://localhost:8888/status
   ```
2. 检查 `config.yaml` 中的 `market_status_url` 是否正确
3. 检查防火墙是否阻止了连接
4. 检查端口是否被占用：
   ```bash
   lsof -i :8888
   ```

### 问题2：状态修改后程序没有切换

**症状**：修改状态后，程序日志中没有看到数据源切换

**解决方案**：
1. 检查程序日志，确认是否收到了新的市场状态
2. 程序每3秒轮询一次，等待3秒后再次检查
3. 检查程序日志中的市场状态值是否正确：
   ```bash
   # 查看模拟服务返回的状态
   curl http://localhost:8888/market/get
   ```
4. 检查程序日志中的市场状态解析是否正确

### 问题3：状态文件无法加载

**症状**：启动服务时提示 `无法加载状态文件`

**解决方案**：
1. 检查文件路径是否正确
2. 检查文件格式是否为有效的JSON
3. 检查文件权限是否可读：
   ```bash
   ls -l market_status.json
   ```

## 与生产环境的区别

| 特性 | 模拟服务 | 生产环境 |
|------|---------|---------|
| 状态来源 | 本地HTTP服务 | 真实API |
| 状态控制 | 可随时修改 | 由市场决定 |
| 响应格式 | 与生产环境一致 | 真实API响应 |
| 用途 | 测试 | 生产 |

## 总结

市场状态模拟服务是一个简单而强大的测试工具，可以：

- ✅ 随时控制市场状态，触发数据源切换
- ✅ 测试5%差异检测和告警机制
- ✅ 测试异常恢复流程
- ✅ 验证程序在各种市场状态下的行为

通过这个工具，可以大大简化测试流程，提高测试效率。
