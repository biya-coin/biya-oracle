# 股票代币报价系统产品需求文档（PRD）

> 产品经理：XXX | 版本：V2.5 | 日期：2025年1月

---

## 一、需求背景

### 为什么做

**现状问题**：
- DEX平台需要7×24小时交易股票代币，但传统美股市场只在特定时段交易
- 美股市场：盘前04:00-09:30、盘中09:30-16:00、盘后16:00-20:00（美东时间）
- 夜盘时段20:00-次日04:00（美东时间）美股市场休市，无法获取官方报价
- 用户无法在夜盘时段进行交易
- 持仓市值计算、强平判断等需要实时价格

**解决方案**：
- 美股交易时段（盘前+盘中+盘后）→ 使用纳斯达克官方报价
- 夜盘时段（20:00-次日04:00）→ 使用BlueOcean报价
- 非交易时间（周末、节假日）→ 使用加权合成报价（前一日收盘价40% + Pyth Network 30% + Chainlink 30%）
- 实现7×24小时无缝切换，保证报价连续性

### 目标

- 确保交易平台在任何时段都能获取准确的股票代币价格
- 在美股交易时段（盘前+盘中+盘后）使用权威的纳斯达克报价
- 在夜盘时段使用BlueOcean报价，保证24小时连续性
- 在非交易时间（周末、节假日）使用加权合成报价
- 提供稳定、可靠、低延迟的报价数据（端到端延迟 < 500ms）

### 目标用户

- DEX交易平台的交易系统（内部调用）
- DEX平台的用户（通过交易界面查看价格）

---

## 二、功能列表

### 功能1：实时报价推送
- 子功能1.1：纳斯达克报价实时推送（盘前+盘中+盘后）
- 子功能1.2：BlueOcean报价实时推送（夜盘时段）
- 子功能1.3：加权合成报价实时推送（周末、节假日）
- 子功能1.4：价格变动时立即推送，无变动时5秒心跳保活

### 功能2：数据源自动切换
- 子功能2.1：按时间表自动切换数据源（04:00、09:30、16:00、20:00 美东时间）
- 子功能2.2：数据源故障时自动切换备用方案
- 子功能2.3：切换前后价格差异验证（差异 < 1%正常，≥ 5%暂停交易）

### 功能3：加权价格计算（周末、节假日）
- 子功能3.1：获取前一日盘后收盘价（20:00美东时间时的纳斯达克收盘价）
- 子功能3.2：查询Pyth Network最新价格
- 子功能3.3：查询Chainlink最新价格
- 子功能3.4：按权重计算加权平均价格
- 子功能3.5：任一预言机价格更新时重新计算

### 功能4：异常检测与处理
- 子功能4.1：价格异常检测（跳变 > 10%）
- 子功能4.2：数据源故障检测（连接超时、数据延迟）
- 子功能4.3：自动降级处理（部分数据源异常时调整权重）
- 子功能4.4：异常告警通知

### 功能5：特殊情况处理
- 子功能5.1：熔断机制检测与处理（一级、二级、三级熔断）
- 子功能5.2：半日交易识别与处理（提前收盘）
- 子功能5.3：熔断期间切换到备用数据源
- 子功能5.4：半日交易收盘后切换到夜盘数据源

---

## 三、业务流程

### 流程1：数据源切换流程

```
系统到达切换时间点（美东时间）
    ↓
判断切换类型
    ├─ 04:00美东时间（加权合成报价/BlueOcean → 纳斯达克）
    │  └─ 切换到纳斯达克（盘前开始）
    │
    ├─ 09:30美东时间（纳斯达克盘前 → 纳斯达克盘中）
    │  └─ 继续使用纳斯达克（无需切换数据源）
    │
    ├─ 13:00美东时间（半日交易提前收盘）
    │  ├─ 检查是否为半日交易日
    │  │  ├─ 是 → 获取纳斯达克收盘价（13:00时的价格）→ 切换到加权合成报价（收盘价40% + Pyth30% + Chainlink30%）→ 完成
    │  │  └─ 否 → 继续使用纳斯达克（正常交易日）
    │
    ├─ 16:00美东时间（纳斯达克盘中 → 纳斯达克盘后）
    │  ├─ 检查是否处于熔断状态
    │  │  ├─ 一级/二级熔断 → 继续使用加权合成报价（15分钟后恢复）
    │  │  ├─ 三级熔断 → 继续使用加权合成报价（当日不再恢复）
    │  │  └─ 正常 → 继续使用纳斯达克（无需切换数据源）
    │
    └─ 20:00美东时间（纳斯达克 → BlueOcean）
        └─ 切换到BlueOcean（夜盘开始）
    ↓
提前5分钟（美东时间）：检查目标数据源连接状态
    ├─ 连接失败 → 每30秒重试，连续3次失败则使用备用方案 → 告警
    │  ├─ 纳斯达克失败 → 切换到BlueOcean（夜盘）或加权合成报价（周末/节假日）
    │  └─ BlueOcean失败 → 切换到加权合成报价
    └─ 连接成功 ↓
切换前1分钟（美东时间）：发送切换预警通知
    ↓
切换时刻（美东时间，精确到秒）：
    ├─ 停止当前数据源订阅
    ├─ 启动目标数据源订阅
    ├─ 获取目标数据源最新价格
    └─ 更新系统报价数据
    ↓
切换后30秒内（美东时间）：验证切换结果
    ├─ 对比切换前后价格差异
    │  ├─ 差异 < 1% → 正常切换 ✅ → 记录日志 → 完成
    │  ├─ 差异 1%-5% → 记录警告 ⚠️ → 继续使用 → 完成
    │  └─ 差异 ≥ 5% → 暂停交易 ❌ → 告警 → 完成
    └─ 验证新数据源数据质量
        ├─ 数据异常 → 回滚切换 → 告警 → 完成
        └─ 数据正常 → 记录切换日志 → 完成
```

### 流程2：BlueOcean报价流程（夜盘时段）

```
进入夜盘时段（20:00 美东时间）
    ↓
连接BlueOcean数据源
    ├─ 连接失败 → 每30秒重试，连续3次失败则切换到加权合成报价 → 完成
    └─ 连接成功 ↓
订阅BlueOcean价格推送
    ↓
接收价格更新
    ├─ 价格异常（跳变 > 10%）→ 使用最后一次有效价格 → 记录警告 → 完成
    └─ 价格正常 ↓
更新系统报价
    ↓
推送给客户端
    ↓
完成
```

### 流程3：加权价格计算流程（周末、节假日）

```
进入非交易时间（周末或节假日）
    ↓
获取前一日盘后收盘价
    ├─ 获取失败 → 使用最近一个交易日的收盘价 → 记录日志
    └─ 获取成功 ↓
查询Pyth Network最新价格
    ├─ 查询失败 → 标记Pyth异常 → 进入异常处理
    └─ 查询成功 ↓
查询Chainlink最新价格
    ├─ 查询失败 → 标记Chainlink异常 → 进入异常处理
    └─ 查询成功 ↓
数据校验
    ├─ 检查价格是否在合理范围内（> 0 且 < 100,000）
    │  ├─ 不合理 → 标记异常 → 进入异常处理
    │  └─ 合理 ↓
    ├─ 检查价格时间戳是否有效（< 5分钟）
    │  ├─ 过期 → 标记异常 → 进入异常处理
    │  └─ 有效 ↓
    └─ 检查价格是否异常（价格跳变判断规则详见4.5计算公式章节）
        ├─ Pyth价格跳变 > 10% → 标记Pyth异常 → 进入异常处理
        ├─ Chainlink价格跳变 > 10% → 标记Chainlink异常 → 进入异常处理
        └─ 价格正常 ↓
计算加权价格
    ├─ 加权价格 = 0.4 × 收盘价 + 0.3 × Pyth价格 + 0.3 × Chainlink价格
    ├─ 价格格式化（详见六、数据格式章节）
    └─ 记录计算日志
    ↓
更新系统报价
    ↓
推送给客户端
    ↓
完成
```

### 流程4：异常处理流程

```
检测到数据源异常
    ↓
判断异常类型
    ├─ Pyth Network价格异常（跳变 > 10%或查询失败）
    │  └─ 使用降级权重：收盘价(60%) + Chainlink(40%)
    │      └─ 重新计算加权价格 → 更新报价 → 记录异常日志 → 完成
    │      （跳变判断规则详见4.5计算公式章节）
    │
    ├─ Chainlink价格异常（跳变 > 10%或查询失败）
    │  └─ 使用降级权重：收盘价(60%) + Pyth(40%)
    │      └─ 重新计算加权价格 → 更新报价 → 记录异常日志 → 完成
    │      （跳变判断规则详见4.5计算公式章节）
    │
    ├─ 收盘价异常（缺失或异常）
    │  └─ 使用降级权重：Pyth(50%) + Chainlink(50%)
    │      └─ 重新计算加权价格 → 更新报价 → 记录异常日志 → 完成
    │
    └─ 两个预言机都异常
        ├─ 使用最后一次有效加权价格
        ├─ 标记为"数据延迟"
        ├─ 发送告警通知
        └─ 限制交易功能（仅允许平仓）→ 完成
```

### 流程5：价格推送流程

```
价格数据更新
    ↓
判断更新类型
    ├─ 纳斯达克价格变动（盘前+盘中+盘后）
    │  └─ 立即推送最新价格 → 完成
    │
    ├─ BlueOcean价格更新（夜盘时段）
    │  └─ 立即推送最新价格 → 完成
    │
    ├─ Pyth Network价格更新（周末、节假日、熔断期间、半日交易收盘后）
    │  └─ 重新计算加权价格 → 推送新价格 → 完成
    │
    ├─ Chainlink价格更新（周末、节假日、熔断期间、半日交易收盘后）
    │  └─ 重新计算加权价格 → 推送新价格 → 完成
    │
    └─ 无价格变动（超过5秒）
        └─ 发送心跳消息 → 完成
```

### 流程6：熔断处理流程

```
检测到熔断触发（纳斯达克数据源）
    ↓
获取熔断前最后一次有效纳斯达克价格（作为收盘价）
    ↓
判断熔断级别
    ├─ 一级熔断（下跌7%）
    │  ├─ 记录日志："一级熔断触发，暂停交易15分钟"
    │  ├─ 标记市场状态为"熔断中"
    │  ├─ 停止纳斯达克数据源订阅
    │  ├─ 切换到加权合成报价（收盘价40% + Pyth30% + Chainlink30%）
    │  ├─ 价格格式化（详见六、数据格式章节）
    │  └─ 15分钟后恢复纳斯达克报价 → 完成
    │
    ├─ 二级熔断（下跌13%）
    │  ├─ 记录日志："二级熔断触发，暂停交易15分钟"
    │  ├─ 标记市场状态为"熔断中"
    │  ├─ 停止纳斯达克数据源订阅
    │  ├─ 切换到加权合成报价（收盘价40% + Pyth30% + Chainlink30%）
    │  ├─ 价格格式化（详见六、数据格式章节）
    │  └─ 15分钟后恢复纳斯达克报价 → 完成
    │
    └─ 三级熔断（下跌20%）
        ├─ 记录日志："三级熔断触发，当日停止交易"
        ├─ 标记市场状态为"熔断中-当日停止"
        ├─ 停止纳斯达克数据源订阅
        ├─ 切换到加权合成报价（收盘价40% + Pyth30% + Chainlink30%）
        ├─ 价格格式化（详见六、数据格式章节）
        ├─ 发送告警通知
        └─ 当日不再恢复纳斯达克报价 → 完成
```

### 流程7：半日交易处理流程

```
检测到半日交易（提前收盘，通常13:00美东时间）
    ↓
识别半日交易日期
    ├─ 感恩节前一天
    ├─ 圣诞节前一天
    ├─ 其他法定半日交易日
    └─ 系统自动识别或手动配置
    ↓
半日交易收盘时刻（13:00美东时间）
    ├─ 记录日志："半日交易，提前收盘"
    ├─ 获取纳斯达克收盘价（13:00时的价格）
    ├─ 停止纳斯达克数据源订阅
    ├─ 切换到加权合成报价（收盘价40% + Pyth30% + Chainlink30%）
    ├─ 价格格式化（详见六、数据格式章节）
    └─ 标记为"半日交易-已收盘"
    ↓
20:00美东时间（正常夜盘开始时间）
    ├─ 继续使用加权合成报价（收盘价40% + Pyth30% + Chainlink30%）
    └─ 完成
```

---

## 四、业务规则

### 4.1 时间规则表

| 项目 | 规则 | 备注 |
|-----|------|------|
| **盘前交易时段** | 04:00 - 09:30（美东时间） | 使用纳斯达克报价 |
| **正常交易时段** | 09:30 - 16:00（美东时间） | 使用纳斯达克报价 |
| **盘后交易时段** | 16:00 - 20:00（美东时间） | 使用纳斯达克报价 |
| **夜盘时段** | 20:00 - 次日04:00（美东时间） | 使用BlueOcean报价 |
| **周末** | 周六、周日全天 | 使用加权合成报价 |
| **节假日** | 美股法定节假日全天 | 使用加权合成报价 |
| **切换时间点** | 04:00、09:30、16:00、20:00（美东时间） | 精确到秒 |
| **半日交易收盘时间** | 13:00（美东时间） | 感恩节前一天、圣诞节前一天等 |
| **判断逻辑** | 交易日：盘前+盘中+盘后用纳斯达克，夜盘用BlueOcean<br>非交易日（周末/节假日）：全天用加权合成报价<br>半日交易：13:00收盘后全天使用加权合成报价<br>熔断期间：使用加权合成报价（一级/二级15分钟后恢复，三级当日不恢复） | 系统自动判断 |

### 4.2 加权报价规则表

| 项目 | 规则 | 备注 |
|-----|------|------|
| **收盘价权重** | 40% | 前一日盘后收盘价（20:00美东时间时的纳斯达克收盘价） |
| **Pyth Network权重** | 30% | 去中心化预言机价格 |
| **Chainlink权重** | 30% | 去中心化预言机价格 |
| **价格精度** | 价格 < 1美元：保留4位小数（舍位）<br>价格 ≥ 1美元：保留2位小数（舍位） | 按照美股价格格式 |
| **更新触发** | 任一预言机价格更新时重新计算 | 收盘价固定不变 |
| **价格有效期** | 预言机价格时间戳 < 5分钟 | 超过5分钟视为过期 |
| **适用时段** | 周末、节假日全天；熔断期间；半日交易收盘后 | 非交易时间或特殊交易情况使用 |

### 4.3 降级权重规则表

| 异常情况 | 降级权重 | 说明 |
|---------|---------|------|
| **Pyth异常** | 收盘价60% + Chainlink 40% | Pyth价格异常或查询失败 |
| **Chainlink异常** | 收盘价60% + Pyth 40% | Chainlink价格异常或查询失败 |
| **收盘价异常** | Pyth 50% + Chainlink 50% | 收盘价缺失或异常 |
| **两个预言机都异常** | 使用最后一次有效加权价格 | 标记为"数据延迟"，限制交易 |

### 4.4 价格校验规则表

| 校验项 | 规则 | 处理方式 |
|-------|------|---------|
| **价格范围** | > 0 且 < 100,000 | 超出范围标记异常 |
| **价格时间戳** | < 5分钟 | 超过5分钟视为过期 |
| **价格跳变** | 单次变动 < 10% | 跳变 ≥ 10%标记异常 |
| **Pyth价格跳变判断** | 价格差异 = \|(当前Pyth价格 - 上次Pyth价格) / 上次Pyth价格\| × 100%<br>如果上次价格不存在，则与收盘价对比<br>价格差异 > 10%判定为异常 | 与上次Pyth价格或收盘价对比 |
| **Chainlink价格跳变判断** | 价格差异 = \|(当前Chainlink价格 - 上次Chainlink价格) / 上次Chainlink价格\| × 100%<br>如果上次价格不存在，则与收盘价对比<br>价格差异 > 10%判定为异常 | 与上次Chainlink价格或收盘价对比 |
| **切换价格差异** | 差异 < 1%正常，≥ 5%暂停交易 | 1%-5%记录警告 |

### 4.5 计算公式

```
加权价格计算公式（计算后按价格格式化）：
原始价格 = 收盘价 × 0.4 + Pyth价格 × 0.3 + Chainlink价格 × 0.3
如果 原始价格 < 1：
    加权价格 = Math.floor(原始价格 × 10000) / 10000  // 保留4位小数，舍位
否则：
    加权价格 = Math.floor(原始价格 × 100) / 100  // 保留2位小数，舍位

降级权重计算公式（计算后按价格格式化）：
Pyth异常：
    原始价格 = 收盘价 × 0.6 + Chainlink价格 × 0.4
    加权价格 = 格式化(原始价格)  // 按上述规则格式化

Chainlink异常：
    原始价格 = 收盘价 × 0.6 + Pyth价格 × 0.4
    加权价格 = 格式化(原始价格)  // 按上述规则格式化

收盘价异常：
    原始价格 = Pyth价格 × 0.5 + Chainlink价格 × 0.5
    加权价格 = 格式化(原始价格)  // 按上述规则格式化

价格差异计算：
价格差异 = Math.abs((新价格 - 旧价格) / 旧价格) × 100%

价格跳变判断计算公式：
Pyth价格跳变判断：
    如果存在上次Pyth价格：
        价格差异 = Math.abs((当前Pyth价格 - 上次Pyth价格) / 上次Pyth价格) × 100%
    否则（首次获取或上次价格不存在）：
        价格差异 = Math.abs((当前Pyth价格 - 收盘价) / 收盘价) × 100%
    如果 价格差异 > 10%：
        判定为价格跳变异常，标记Pyth异常
    否则：
        判定为正常，使用Pyth价格

Chainlink价格跳变判断：
    如果存在上次Chainlink价格：
        价格差异 = Math.abs((当前Chainlink价格 - 上次Chainlink价格) / 上次Chainlink价格) × 100%
    否则（首次获取或上次价格不存在）：
        价格差异 = Math.abs((当前Chainlink价格 - 收盘价) / 收盘价) × 100%
    如果 价格差异 > 10%：
        判定为价格跳变异常，标记Chainlink异常
    否则：
        判定为正常，使用Chainlink价格

价格格式化函数：
function formatPrice(price) {
    if (price < 1) {
        return Math.floor(price * 10000) / 10000;  // 保留4位小数，舍位
    } else {
        return Math.floor(price * 100) / 100;  // 保留2位小数，舍位
    }
}
```

### 4.6 更新频率规则

| 场景 | 更新频率 | 说明 |
|------|---------|------|
| **纳斯达克价格变动** | 立即推送 | 盘前+盘中+盘后，每次价格变动都推送 |
| **BlueOcean价格更新** | 立即推送 | 夜盘时段，每次价格变动都推送 |
| **Pyth价格更新** | 立即重新计算并推送 | 周末、节假日、熔断期间、半日交易收盘后，每次链上更新 |
| **Chainlink价格更新** | 立即重新计算并推送 | 周末、节假日、熔断期间、半日交易收盘后，每次链上更新 |
| **无价格变动** | 5秒心跳 | 保持连接活跃 |
| **数据源切换** | 立即推送 | 切换时推送最新价格 |
| **系统启动** | 立即推送 | 启动时推送所有股票价格 |

### 4.7 熔断机制规则表

| 熔断级别 | 触发条件 | 暂停时长 | 处理方式 | 备注 |
|---------|---------|---------|---------|------|
| **一级熔断** | 下跌7% | 15分钟 | 获取熔断前最后一次有效纳斯达克价格作为收盘价，切换到加权合成报价（收盘价40% + Pyth30% + Chainlink30%） | 15分钟后恢复纳斯达克报价 |
| **二级熔断** | 下跌13% | 15分钟 | 获取熔断前最后一次有效纳斯达克价格作为收盘价，切换到加权合成报价（收盘价40% + Pyth30% + Chainlink30%） | 15分钟后恢复纳斯达克报价 |
| **三级熔断** | 下跌20% | 当日停止交易 | 获取熔断前最后一次有效纳斯达克价格作为收盘价，切换到加权合成报价（收盘价40% + Pyth30% + Chainlink30%） | 当日不再恢复纳斯达克报价 |

### 4.8 半日交易规则表

| 项目 | 规则 | 备注 |
|-----|------|------|
| **半日交易日** | 感恩节前一天、圣诞节前一天等 | 系统自动识别或手动配置 |
| **收盘时间** | 13:00（美东时间） | 比正常收盘时间提前3小时 |
| **收盘后处理** | 13:00后全天使用加权合成报价 | 收盘价40% + Pyth30% + Chainlink30% |
| **收盘价获取** | 使用13:00时的纳斯达克收盘价 | 作为加权合成报价的收盘价权重 |
| **价格更新** | 任一预言机价格更新时重新计算加权价格 | 收盘价固定不变 |

### 4.9 异常处理规则

| 场景 | 提示信息 | 处理方式 |
|-----|---------|---------|
| **纳斯达克连接失败** | 记录日志："纳斯达克数据源连接失败" | 切换到BlueOcean（夜盘）或加权合成报价（周末/节假日），发送告警 |
| **BlueOcean连接失败** | 记录日志："BlueOcean数据源连接失败" | 切换到加权合成报价，发送告警 |
| **Pyth价格查询失败** | 记录日志："Pyth Network价格查询失败" | 使用降级权重（收盘价60% + Chainlink 40%） |
| **Chainlink价格查询失败** | 记录日志："Chainlink价格查询失败" | 使用降级权重（收盘价60% + Pyth 40%） |
| **收盘价缺失** | 记录日志："前一日收盘价缺失，使用历史收盘价" | 使用最近一个交易日的收盘价 |
| **价格跳变 > 10%** | 记录警告："价格异常跳变，使用降级权重" | 标记异常数据源，使用降级权重计算 |
| **切换价格差异 ≥ 5%** | 记录错误："切换价格差异过大，暂停交易" | 暂停该交易对的交易功能，发送告警 |
| **两个预言机都异常** | 记录错误："加权报价数据源全部异常" | 使用最后一次有效价格，标记"数据延迟"，限制交易 |
| **价格时间戳过期** | 记录警告："价格数据过期，使用缓存价格" | 使用最后一次有效价格 |
| **网络异常** | 记录错误："网络连接异常" | 使用缓存价格，标记"数据延迟" |
| **一级熔断触发** | 记录日志："一级熔断触发，暂停交易15分钟" | 获取熔断前最后一次有效纳斯达克价格作为收盘价，切换到加权合成报价（收盘价40% + Pyth30% + Chainlink30%），15分钟后恢复纳斯达克报价 |
| **二级熔断触发** | 记录日志："二级熔断触发，暂停交易15分钟" | 获取熔断前最后一次有效纳斯达克价格作为收盘价，切换到加权合成报价（收盘价40% + Pyth30% + Chainlink30%），15分钟后恢复纳斯达克报价 |
| **三级熔断触发** | 记录错误："三级熔断触发，当日停止交易" | 获取熔断前最后一次有效纳斯达克价格作为收盘价，切换到加权合成报价（收盘价40% + Pyth30% + Chainlink30%），当日不再恢复纳斯达克报价 |
| **半日交易提前收盘** | 记录日志："半日交易，提前收盘" | 获取13:00收盘价，切换到加权合成报价（收盘价40% + Pyth30% + Chainlink30%），全天使用加权合成报价 |

---

## 五、状态管理

### 5.1 数据源状态定义

| 状态 | 含义 | 说明 |
|-----|------|------|
| **ACTIVE** | 活跃 | 当前正在使用的数据源 |
| **STANDBY** | 待机 | 备用数据源，准备切换 |
| **ERROR** | 错误 | 数据源异常，无法使用 |
| **SWITCHING** | 切换中 | 正在执行数据源切换 |

### 5.2 报价状态定义

| 状态 | 含义 | 说明 |
|-----|------|------|
| **NORMAL** | 正常 | 价格数据正常，可正常使用 |
| **DELAYED** | 延迟 | 价格数据延迟，使用缓存价格 |
| **ANOMALY** | 异常 | 价格数据异常，使用降级方案 |
| **UNAVAILABLE** | 不可用 | 无法获取价格数据 |

### 5.3 状态流转

```
数据源状态流转：
ACTIVE → 到达切换时间点 → SWITCHING → 切换成功 → ACTIVE（新数据源）
ACTIVE → 数据源故障 → ERROR → 切换到备用 → ACTIVE（备用数据源）

报价状态流转：
NORMAL → 数据延迟 > 5秒 → DELAYED → 数据恢复 → NORMAL
NORMAL → 价格异常 → ANOMALY → 使用降级方案 → NORMAL
NORMAL → 所有数据源故障 → UNAVAILABLE → 数据源恢复 → NORMAL
```

---

## 六、数据格式

**价格格式规则**：
- 价格 < 1美元：保留4位小数，舍位（向下取整）
- 价格 ≥ 1美元：保留2位小数，舍位（向下取整）
- 示例：
  - 0.12345 → 0.1234（4位小数，舍位）
  - 0.9999 → 0.9999（4位小数，舍位）
  - 1.23456 → 1.23（2位小数，舍位）
  - 180.567 → 180.56（2位小数，舍位）

**报价说明**：
- 系统仅提供最新价格报价
- 所有数据源（纳斯达克、BlueOcean、加权合成报价）统一按照上述价格格式规则输出

---

## 七、测试要点

### 7.1 正常流程测试

- [ ] 美股交易时段（04:00-20:00美东时间）使用纳斯达克报价
- [ ] 夜盘时段（20:00-次日04:00美东时间）使用BlueOcean报价
- [ ] 周末、节假日使用加权合成报价
- [ ] 数据源切换时间点（04:00、09:30、16:00、20:00美东时间）自动切换
- [ ] 切换前后价格差异 < 1%，切换成功
- [ ] 加权价格计算正确（收盘价40% + Pyth30% + Chainlink30%）
- [ ] 价格格式化正确：价格 < 1美元保留4位小数（舍位），价格 ≥ 1美元保留2位小数（舍位）
- [ ] 价格更新时立即推送给客户端
- [ ] 无价格变动时5秒发送心跳

### 7.2 异常场景测试

- [ ] Pyth Network价格查询失败，使用降级权重（收盘价60% + Chainlink 40%）
- [ ] Chainlink价格查询失败，使用降级权重（收盘价60% + Pyth 40%）
- [ ] 收盘价缺失，使用最近一个交易日的收盘价
- [ ] 价格跳变 > 10%，标记异常并使用降级权重
- [ ] 切换价格差异 ≥ 5%，暂停交易
- [ ] 两个预言机都异常，使用最后一次有效价格，标记"数据延迟"
- [ ] 价格时间戳过期（> 5分钟），使用缓存价格

### 7.3 边界情况测试

- [ ] 切换时间点正好是00:00:00（跨天）
- [ ] 节假日全天使用加权合成报价（非BlueOcean）
- [ ] 周末全天使用加权合成报价（非BlueOcean）
- [ ] 夜盘时段使用BlueOcean报价（非加权合成报价）
- [ ] 夏令时切换时时间规则自动调整
- [ ] 价格 = 0 或价格 < 0 的情况
- [ ] 价格 > 100,000 的情况
- [ ] 价格 < 1美元时，格式化保留4位小数（舍位），如0.12345 → 0.1234
- [ ] 价格 ≥ 1美元时，格式化保留2位小数（舍位），如1.23456 → 1.23
- [ ] 连续多次数据源切换的情况

### 7.5 特殊情况测试

- [ ] 一级熔断触发（下跌7%），暂停15分钟，切换到加权合成报价（收盘价40% + Pyth30% + Chainlink30%），15分钟后恢复纳斯达克报价
- [ ] 二级熔断触发（下跌13%），暂停15分钟，切换到加权合成报价（收盘价40% + Pyth30% + Chainlink30%），15分钟后恢复纳斯达克报价
- [ ] 三级熔断触发（下跌20%），当日停止交易，切换到加权合成报价（收盘价40% + Pyth30% + Chainlink30%）
- [ ] 半日交易（感恩节前一天），13:00提前收盘，切换到加权合成报价（收盘价40% + Pyth30% + Chainlink30%）
- [ ] 半日交易（圣诞节前一天），13:00提前收盘，切换到加权合成报价（收盘价40% + Pyth30% + Chainlink30%）
- [ ] 半日交易收盘后，全天继续使用加权合成报价（不切换到BlueOcean）
- [ ] 熔断期间价格更新使用加权合成报价（任一预言机更新时重新计算）
- [ ] 半日交易收盘价正确获取（13:00时的价格）
- [ ] 熔断恢复后正确切换回纳斯达克报价（一级、二级熔断）
- [ ] 三级熔断后当日不再恢复纳斯达克报价
- [ ] 熔断前最后一次有效纳斯达克价格正确作为收盘价使用

### 7.4 性能测试

- [ ] 端到端延迟 < 500ms
- [ ] 支持100+股票代币同时报价
- [ ] 支持10,000+并发连接
- [ ] 每秒处理50,000+消息

---

## 八、术语表

| 术语 | 解释 |
|------|------|
| **盘前交易** | 美股市场开盘前的交易时段（04:00-09:30 美东时间） |
| **盘中交易** | 美股市场正常交易时段（09:30-16:00 美东时间） |
| **盘后交易** | 美股市场收盘后的交易时段（16:00-20:00 美东时间） |
| **夜盘时段** | 美股市场休市时段（20:00-次日04:00 美东时间） |
| **BlueOcean** | 夜盘时段使用的数据源提供商 |
| **加权合成报价** | 周末、节假日使用多个数据源按权重计算的价格 |
| **前一日收盘价** | 前一个交易日20:00时的纳斯达克收盘价 |
| **价格跳变** | 价格在短时间内大幅变动（单次变动 > 10%） |
| **数据延迟** | 数据从数据源到系统的传输延迟 |
| **降级方案** | 部分数据源异常时使用的备用权重配置 |
| **熔断机制** | 美股市场为防止市场剧烈波动而设置的暂停交易机制，分为一级（下跌7%）、二级（下跌13%）、三级（下跌20%） |
| **一级熔断** | 市场下跌7%时触发，暂停交易15分钟 |
| **二级熔断** | 市场下跌13%时触发，暂停交易15分钟 |
| **三级熔断** | 市场下跌20%时触发，当日停止交易 |
| **半日交易** | 某些节假日前一天，美股市场提前收盘（通常13:00美东时间），如感恩节前一天、圣诞节前一天 |

---

